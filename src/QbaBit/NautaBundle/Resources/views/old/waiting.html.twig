{% extends "QbaBitNautaBundle:Default:_base.html.twig" %}
{% block scripts_header %}
<script type="text/javascript">

    //显示在线时间
    function $$(tt){return tt<10?"0"+tt : tt;};
    var today   = new Date();
    var hour  = $$(today.getHours() );
    var minu  = $$(today.getMinutes());
    var second= $$(today.getSeconds());
    var actime= 'null';
    if('notFound.jsp' != 'notFound.jsp')
    {
        var newWnd =window.open("notFound.jsp","_blank");newWnd.opener = null;
    }
    function set()
    {

      //  var loginTime=parseInt((new Date().getTime()-today.getTime())/1000);
        var loginTime=parseInt((new Date().getTime()-today.getTime())/1000);
        if(loginTime++ > 600000)
        {
            today =new Date() ;
            //你已经登录了一个星期了，时间重置！
            alert("Ha iniciado sesión en una semana. Reajuste el tiempo.");
        }
        if(actime > 0)
        {
            setonTime(actime);
            actime++;
        }
        else if(loginTime >0)
        {
            setonTime(loginTime);
        }
    }
    setInterval(set,1000);
   var  sourceTime = {{ time|json_encode|raw }}
    function setonTime(loginTime)
    {
        /*
           var t =
        var s = t.getFullYear() + "/"+(t.getMonth()+1)+"/"+t.getDate()
        var loginTime = parseInt( ( ).getTime()-today.getTime())/1000);
    */

        var hours   = 0;
        var minutes = 0;
        var seconds = 0;

        hours = Math.floor(loginTime/3600);
        minutes = Math.floor((loginTime%3600)/60);
        seconds = loginTime%60;

        if(hours <= 9)
        {
            hours="0"+hours;
        }
        if(minutes <= 9)
        {
            minutes="0"+minutes;
        }
        if(seconds <= 9)
        {
            seconds="0"+seconds;
        }

        var t1 = new Date("2001/01/01 "+sourceTime.h+":"+sourceTime.i+":"+sourceTime.s)
        var t2 = new Date("2001/01/01 "+hours+":"+minutes	+":"+seconds)
        t1.setHours(t1.getHours() - t2.getHours(), t1.getMinutes() - t2.getMinutes(), t1.getSeconds() - t2.getSeconds());

        var cdate = getTimeStr(sourceTime.h - hours) + ":" + getTimeStr(t1.getMinutes())  + ":" + getTimeStr(t1.getSeconds());
       if(cdate=="00:00:00"|| document.getElementById('onlineTime').innerHTML == "Reiniciando conexión.")
       {
           if( document.getElementById('onlineTime').innerHTML != "Reiniciando conexión.")
           setTimeout(function(){
               document.location.href = "{{ url("qba_bit_nauta_index") }}";
           },2000);
           document.getElementById('onlineTime').innerHTML = "Reiniciando conexión.";
       }
       else
        document.getElementById('onlineTime').innerHTML = cdate;
    }

    var g_httpRequest        = null;

    var g_isSubmitLogout = false;

    //登录后提示退出
    function windowExitFunc(e)
    {
        var event= window.event||e;
        try
        {
            if(g_isSubmitLogout)
            {
                return false;
            }

            var message = "Visitar otros sitios web en esta página le llevará fuera de línea de forma anormal. Para visitar otros sitios web, haga clic en Cancelar y abra una nueva página.";

            if (event)
            {
                event.returnValue = message;
            }

        }
        catch(e)
        {
            alert("alert window error!!!");
        }
        return true;
    }

    function userSubmitLogout(forzada)
    {
        if(!confirm("Se le desconectará. ¿Seguro que quieres cerrar sesión?"))
        {
            return false;
        }

        logoutImpl(forzada);
        return true;
    }

    function logoutImpl(forzada)
    {
        pageOnunload(forzada);
    }

    function pageOnunload(forzada)
    {
        //if(!g_httpRequest){ g_httpRequest = createHttpRequest(); }
        var cookieCheck = document.getElementById("removeCookie");
        var removeCookie = "1";
        if (cookieCheck && cookieCheck.checked == true) {
            removeCookie = cookieCheck.value;
        }
        var g_httpRequest = createHttpRequest();
        if (g_httpRequest == null)
        {
            alert("Se desconecta de forma anormal. Por favor, póngase en contacto con el administrador de la red.");
            return false;
        }
        else
        {
          /*  $.ajax({
                url: ""+"/"+forzada,

                data: null,
                type: "GET",

                enctype: 'multipart/form-data',
                success: function(e){
                  if(e.return==0)
                      alert("No se pudo cerrar la session");
                  else
                  {
                      document.location.href = e.url;
                  }
                },
                error: function(){
                    alert("No se pudo cerrar la session");

                },
                processData: false,
                contentType: false

            });
         /*


            var urlParam = "ATTRIBUTE_UUID=5D2F4A62469AE9D1EA957FA855ADDBA6&"

  +data

                + "&domain="


                +"&remove="+removeCookie;
            g_httpRequest.open("GET", "/LogoutServlet?CSRFHW=aba3bfcf2bd9177c16e5f7247133c0b0&" + urlParam, true);
            g_httpRequest.send();
            var isOut;
            g_httpRequest.onreadystatechange=function()
            {
                if (g_httpRequest.readyState==4 && g_httpRequest.status==200)
                {
                    if(g_httpRequest.responseText.indexOf("SUCCESS") != -1)
                    {
                        if (g_httpRequest.responseText.indexOf("REMOVE_AUTHINFO_SUCCESS") != -1)
                        {
                            alert("???logout_result.removecookie.success???");
                        }
                        else if(g_httpRequest.responseText.indexOf("ERROR") != -1){
                            alert("???logout_result.removecookie.fail???");
                        }
                        isOut = true;
                    }
                    else
                    {
                        isOut = true;
                    }
                    if(isOut == false)
                    {
                        alert("Se desconecta de forma anormal. Por favor, póngase en contacto con el administrador de la red.");
                        return;
                    }
                    else if (isOut == null)
                    {
                        alert("Su red está desconectada. Compruébelo por favor.");
                        g_isSubmitLogout = true;
                        logoutToFirstPage();
                        return;
                    }
                    // alert("???logout_result.logout_success???");
                    g_isSubmitLogout = true;
                    //window.location.replace("http://www.google.com");
                    logoutToFirstPage();
                }
                else
                {
                    if(g_httpRequest.readyState==4 && g_httpRequest.status != 200)
                    {
                        alert("request error "  + g_httpRequest.status);
                        return false;
                    }
                }
            }*/
        }
    }
    function logoutToFirstPage()
    {
        //[false alarm:Cross-Site Scripting: Reflected]
        window.location.href="/nauta_etecsa/OnlineURL/offline.jsp?CSRFHW=aba3bfcf2bd9177c16e5f7247133c0b0&lang="+'es_ES';
    }
    function IEkeydown(event)
    {
        if ((event.keyCode == 8)||  //屏蔽退格删除键
            (event.keyCode == 114)||
            (event.keyCode == 116)||            //屏蔽 F5 刷新键
            (event.keyCode == 122))             //屏蔽 F12 刷新键
        {
            event.keyCode=0;
            event.returnValue=false;
        }

        if ((event.altKey)&& ((event.keyCode==37)||(event.keyCode==39))) // 屏蔽 Alt + -> 和 Alt+ <-
        {
            event.returnValue=false;
        }

        if (event.ctrlKey ||(event.shiftKey)&&(event.keyCode==121)) //屏蔽 Ctrl 键 和 shift+F10
        {
            event.returnValue=false;
        }
    }

    function FFkeydown(event)
    {
        var key = event.which;
        if ((key == 8) || (key == 114)|| (key == 116)||  (key == 122))                      //屏蔽退格删除键(event.keyCode ==   8)||//屏蔽 F5 刷新键//屏蔽 F12 刷新键
        {
            key=0;
            event.preventDefault();
        }
        if ((event.altKey)&& ((key==37)||(key==39))) // 屏蔽 Alt + -> 和 Alt+ <-
        {
            event.preventDefault();
        }
        if (event.ctrlKey ||(event.shiftKey)&&(key==121)) //屏蔽 Ctrl 键 和 shift+F10
        {
            event.preventDefault();
        }
    }
    function windowKeyDown(e)
    {
        if (window.event)
        {
            var event = window.event;
            IEkeydown(event);
        }
        else
        {
            var event= e;
            FFkeydown(event);
        }
    }

    function createHttpRequest()
    {
        var request;
        try
        {
            request = new XMLHttpRequest();
        }
        catch (trymicrosoft)
        {
            try
            {
                request = new ActiveXObject("Microsoft.XMLHTTP");
            }
            catch (failed)
            {
                try
                {
                    request = new ActiveXObject("Msxml2.XMLHTTP");
                }
                catch (othermicrosoft)
                {
                    request = null;
                }
            }
        }
        return request;
    }

    function windowOnunload()
    {
        if (!g_isSubmitLogout)
        {
            logoutImpl();
        }
    }
    function getTimeStr(time) {
       var time= time.toString();
        if(time.length==1)
           return "0"+time;
        return time;

    }

    function updateAvailableTime()
    {
        console.log("aa");
       // var g_httpRequest = createHttpRequest();
       /* if (g_httpRequest == null)
        {
            alert("Actualización disponible tiempo falle.");
            return;
        }
        else
        {*/
            $.ajax({
                url: "{{ url("qba_bit_nauta_index",{"ajax":"true"}) }}",
                /* method:method,*/
                data: null,
                type: "GET",
                /*  dataType : 'html',*/
                enctype: 'multipart/form-data',
                success: function(e){
                    console.log(e);
                    document.getElementById("availableTime").innerHTML = getTimeStr(e.time.h)+":"+getTimeStr(e.time.i)+":"+getTimeStr(e.time.s);
                },
                error: function(){
                    alert("Actualización disponible tiempo falle.");
                    document.getElementById("availableTime").innerHTML = "--:--:--";
                },
                processData: false,
                contentType: false

            });

            /*g_httpRequest.open("post", , true);
            g_httpRequest.send();
            g_httpRequest.onreadystatechange=function()
            {

                if (g_httpRequest.readyState==2 && g_httpRequest.status==200)
                {

                    //得到最新的有效时间
                    var responseText = g_httpRequest.responseText;
                    console.log("aaaaa");
                    if (responseText.indexOf("errorop") != -1)
                    {
                        alert("Actualización disponible tiempo falle.");
                        document.getElementById("availableTime").innerHTML = "--:--:--";
                        return;
                    }
                    //写入页面
                    document.getElementById("availableTime").innerHTML = responseText;

                }
                else if(g_httpRequest.readyState==4 && g_httpRequest.status != 200)
                {
                    alert("request error "  + g_httpRequest.status);
                    return false;
                }
            }
        }*/
    }
</script>
{% endblock %}


{% block contenedor %}
    <div id="int" class="row" >
        <div class="blq ">
            <div class="title">
                Conexión en Espera
            </div>
            <div class="blq_int ">
                <div id="cont" class="col-xs-12" style="background-color: white;  margin: 0 auto; text-align: center;">
                    <div style="padding: 20px; text-align: center;">
                        <div class="title_text">

                            <span style="padding-left: 10px; font-weight: bold;">
                                {% if forzada.typeClose==1 %}
                                Su conexión fue cerrada forzosamente. Debe esperar unos minutos para volver a iniciar sesión.
                             {% else %}
                                    Su conexión está siendo reiniciada, por favor espere unos minutos.
                                {% endif %}
                            </span>
                        </div>

                        <div class="row" id="logout" style="padding-top: 5px" >
  <div class="col-xs-12">

      <div class="row">
          <div class=" col-xs-6 key">
              Direccion
          </div>
          <div class=" col-xs-6 ">
              {{ ip.ip }}
          </div>
      </div>
      <div class="row">
          <div class=" col-xs-6 key">
              Tiempo faltante
          </div>
          <div class=" col-xs-6 " id="onlineTime">
             00:00:00
          </div>
      </div>
      <div class="row">
          <div class=" col-xs-6 key">
              Tiempo a esperar
          </div>
          <div class=" col-xs-6 " id="availableTime">

          </div>
      </div>
      <div class="row">
          <div class=" col-xs-12">
              <input class="btn" name="refrescar" value="Actualizar" onclick="updateAvailableTime();" type="button">

          </div>

      </div>
  </div>




                        </div>
                    <img src="{{ asset('bundles/qbabitnauta/nauta_wifi_popup.jpg') }}" style="padding: 0 5px 15px 0; width: 190px;">
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block scripts_footer %}
<script type="text/javascript">
   // window.onload = function ()
   // {
        updateAvailableTime();
        set();
     //   updateAvailableTime();
   // }
</script>
{% endblock %}
